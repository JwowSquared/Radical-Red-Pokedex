<!DOCTYPE html>
<html>
<head>
  <title>Transform data.js to JSON for encounters</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
      text-align: center;
    }
    button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .output {
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      max-height: 70vh;
      overflow-y: auto;
      text-align: left;
    }
    h1, h2 {
      margin-top: 20px;
      color: #333;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Transform data.js to JSON for encounters</h1>
  <button id="generate-button">Transform and Download</button>

  <script>
    let repo = "JwowSquared/Radical-Red-Pokedex";
    let version = "rrdex release 1.2.2";

    async function fetchData() {
      let request = new Request(`https://raw.githubusercontent.com/${repo}/master/data.js`);
      let response = null;
      if (typeof caches !== "undefined") {
        const cache = await caches.open(version);
        
        response = await cache.match(request);
        if (!response) {
          response = await fetch(request);
          await cache.put(request, response);
        }
        response = await cache.match(request);
      }
      else {
        response = await fetch(request);
      }
      
      let data = await response.text();
      return new Function("return " + data + ";")();
    }

    function getHeldItems(speciesData, items) {
      if (!speciesData || !speciesData.items) return [];
      
      return speciesData.items
        .filter(itemId => itemId !== 0)
        .map(itemId => {
          const item = items[itemId];
          return item ? {
            id: itemId,
            name: item.name,
            description: item.description
          } : null;
        })
        .filter(item => item !== null);
    }

    const SPECIES_ENCOUNTER_TYPES = new Set([
      'fixed-gift', 'fixed-overworld', 'fixed-roaming', 'fixed-trade',
      'wild-day', 'wild-night', 'wild-oldRod', 'wild-superRod', 'wild-surf',
      'wild-goodRod', 'wild-smash', 'raid1', 'raid2', 'raid3', 'raid4', 'raid5', 'raid6'
    ]);

    function parseEncounterMethod(type, methodData, species, items) {
      const encounters = [];
      
      for (const rateKey in methodData) {
        const encounterList = methodData[rateKey];
        
        if (type.startsWith('fixed-')) {
          if (Array.isArray(encounterList)) {
            encounterList.forEach(speciesId => {
              const speciesData = species[speciesId];
              if (speciesData) {
                encounters.push({
                  species: speciesData.key,
                  speciesId: speciesId,
                  heldItems: getHeldItems(speciesData, items)
                });
              }
            });
          }
        } else if (type.startsWith('wild-')) {
          if (Array.isArray(encounterList) && Array.isArray(encounterList[0])) {
            encounterList.forEach(encounter => {
              if (encounter.length >= 3) {
                const speciesData = species[encounter[0]];
                if (speciesData) {
                  encounters.push({
                    species: speciesData.key,
                    speciesId: encounter[0],
                    minLevel: encounter[1],
                    maxLevel: encounter[2],
                    heldItems: getHeldItems(speciesData, items)
                  });
                }
              }
            });
          }
        } else if (type.startsWith('raid')) {
          if (Array.isArray(encounterList)) {
            encounterList.forEach(raidEncounter => {
              if (Array.isArray(raidEncounter) && raidEncounter.length >= 1) {
                const speciesId = raidEncounter[0];
                const speciesData = species[speciesId];
                if (speciesData) {
                  encounters.push({
                    species: speciesData.key,
                    speciesId: speciesId,
                    heldItems: getHeldItems(speciesData, items)
                  });
                }
              }
            });
          }
        }
      }
      
      return deduplicateEncounters(encounters);
    }

    function deduplicateEncounters(encounters) {
      const seen = new Set();
      return encounters.filter(encounter => {
        const key = JSON.stringify({
          species: encounter.species,
          speciesId: encounter.speciesId,
          minLevel: encounter.minLevel,
          maxLevel: encounter.maxLevel,
          heldItems: encounter.heldItems
        });
        
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    }

    async function generateAndDownload() {
      const data = await fetchData();
      const areaMap = {};

      for (const areaId in data.areas) {
        const area = data.areas[areaId];
        const areaData = {
          ID: parseInt(areaId),
          name: area.name,
          encounters: {}
        };

        for (const key in area) {
          if (SPECIES_ENCOUNTER_TYPES.has(key)) {
            const encounters = parseEncounterMethod(key, area[key], data.species, data.items);
            if (encounters.length > 0) {
              areaData.encounters[key] = encounters;
            }
          }
        }

        areaMap[area.name] = areaData;
      }

      // Create and download the JSON file
      const jsonString = JSON.stringify(areaMap, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'radical-red-locations.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.getElementById('generate-button').addEventListener('click', generateAndDownload);
  </script>
</body>
</html>